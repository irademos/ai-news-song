<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Daily Spin</title>
  <style>
    :root {
      color-scheme: light dark;
      --bg: #0d1117;
      --surface: #161b22;
      --surface-alt: #1f2933;
      --accent: #f59e0b;
      --text: #f8fafc;
      --muted: #94a3b8;
      font-family: "Inter", "Segoe UI", Roboto, system-ui, -apple-system, sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: radial-gradient(circle at top left, rgba(245, 158, 11, 0.08), transparent 45%),
        var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
      padding: 2rem;
    }

    .app-shell {
      display: grid;
      grid-template-columns: minmax(240px, 280px) minmax(320px, 640px);
      gap: 2rem;
      width: min(1080px, 100%);
      background: rgba(15, 23, 42, 0.7);
      backdrop-filter: blur(24px);
      border-radius: 28px;
      padding: 2rem;
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.4);
    }

    @media (max-width: 860px) {
      body {
        padding: 1rem;
      }

      .app-shell {
        grid-template-columns: 1fr;
        padding: 1.5rem;
      }
    }

    h1, h2, h3, p {
      margin: 0;
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }

    .sidebar header {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .sidebar header h2 {
      font-size: 1.25rem;
      font-weight: 600;
      letter-spacing: 0.01em;
    }

    .sidebar header p {
      font-size: 0.9rem;
      color: var(--muted);
    }

    .song-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      list-style: none;
      padding: 0;
      margin: 0;
      overflow-y: auto;
      max-height: calc(100vh - 8rem);
    }

    .song-list button {
      width: 100%;
      background: transparent;
      border: 1px solid rgba(148, 163, 184, 0.2);
      color: inherit;
      padding: 0.9rem 1rem;
      border-radius: 14px;
      text-align: left;
      cursor: pointer;
      transition: transform 0.15s ease, border-color 0.2s ease, background 0.2s ease;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .song-list button:hover {
      transform: translateY(-2px);
      border-color: rgba(245, 158, 11, 0.5);
      background: rgba(15, 23, 42, 0.55);
    }

    .song-list button.active {
      border-color: var(--accent);
      background: rgba(245, 158, 11, 0.12);
    }

    .song-title {
      font-weight: 600;
      font-size: 1rem;
    }

    .song-meta {
      font-size: 0.85rem;
      color: var(--muted);
      display: flex;
      gap: 0.5rem;
      align-items: baseline;
    }

    .player-panel {
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.92), rgba(17, 24, 39, 0.85));
      border-radius: 24px;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      justify-content: space-between;
      box-shadow: inset 0 1px 0 rgba(148, 163, 184, 0.07);
    }

    .player-header {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }

    .player-header h1 {
      font-size: clamp(2rem, 4vw, 2.8rem);
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    .player-header p {
      color: var(--muted);
      font-size: 1rem;
      line-height: 1.6;
    }

    .player-header .tag {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.35rem 0.85rem;
      background: rgba(245, 158, 11, 0.18);
      color: var(--accent);
      border-radius: 999px;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 600;
    }

    audio {
      width: 100%;
      border-radius: 12px;
      height: 54px;
      background: rgba(15, 23, 42, 0.6);
    }

    .lyrics {
      font-size: 0.95rem;
      line-height: 1.7;
      color: rgba(226, 232, 240, 0.9);
      white-space: pre-wrap;
      max-height: 200px;
      overflow-y: auto;
      padding-right: 0.75rem;
    }

    .empty-state {
      color: var(--muted);
      text-align: center;
      padding: 2rem;
    }

    .generate-song {
      margin-top: auto;
      padding-top: 1.25rem;
      border-top: 1px solid rgba(148, 163, 184, 0.15);
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }

    .generate-song button {
      appearance: none;
      border: none;
      border-radius: 14px;
      padding: 0.85rem 1.2rem;
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.92), rgba(234, 179, 8, 0.85));
      color: #0f172a;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.2s ease;
      box-shadow: 0 12px 32px rgba(245, 158, 11, 0.28);
    }

    .generate-song button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 16px 36px rgba(245, 158, 11, 0.34);
    }

    .generate-song button:disabled {
      cursor: not-allowed;
      opacity: 0.7;
      transform: none;
      box-shadow: none;
    }

    .generate-song-status {
      font-size: 0.9rem;
      color: var(--muted);
      min-height: 1.4em;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <aside class="sidebar">
      <header>
        <h2>Recent Spins</h2>
        <p>Catch up on the tracks we've highlighted this week.</p>
      </header>
      <ul class="song-list" id="songList"></ul>
    </aside>

    <main class="player-panel">
      <div class="player-header">
        <span class="tag" id="songTag">Now Playing</span>
        <h1 id="songTitle">Loading...</h1>
        <p id="songMeta">Please select a song from the list.</p>
      </div>

      <audio id="audioPlayer" controls preload="none">
        <source id="audioSource" src="" type="audio/mpeg" />
        Your browser does not support the audio element.
      </audio>

      <section class="lyrics" id="songDescription">
        Choose a song to read a short story about why it made the Daily Spin playlist.
      </section>

      <section class="generate-song">
        <button type="button" id="generateSongButton">Generate Suno Song</button>
        <p class="generate-song-status" id="generateSongStatus" aria-live="polite"></p>
      </section>
    </main>
  </div>

  <template id="songItemTemplate">
    <li>
      <button type="button">
        <span class="song-title"></span>
        <span class="song-meta"></span>
      </button>
    </li>
  </template>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import {
      getFirestore,
      collection,
      query,
      orderBy,
      limit,
      onSnapshot,
      addDoc,
      serverTimestamp,
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    let db = null;
    let songsCache = [];
    let currentSongId = null;
    let unsubscribeSongs = null;
    let firebaseInitPromise = null;

    async function initFirebase() {
      if (firebaseInitPromise) return firebaseInitPromise;

      firebaseInitPromise = (async () => {
        const response = await fetch('/api/firebase-config');
        if (!response.ok) {
          throw new Error('Unable to load Firebase configuration.');
        }

        const config = await response.json();
        const app = initializeApp(config);
        db = getFirestore(app);
        return db;
      })();

      return firebaseInitPromise;
    }

    function resetNowPlaying() {
      const title = document.getElementById('songTitle');
      const meta = document.getElementById('songMeta');
      const description = document.getElementById('songDescription');
      const audio = document.getElementById('audioPlayer');
      const source = document.getElementById('audioSource');
      const tag = document.getElementById('songTag');

      title.textContent = 'Waiting for a spin';
      meta.textContent = 'Generate a Suno song to start your listening session.';
      description.textContent = 'Lyrics will appear here after you generate a track.';
      source.src = '';
      audio.load();
      tag.textContent = 'Now Playing';
      tag.style.background = 'rgba(245, 158, 11, 0.18)';
      tag.style.color = 'var(--accent)';
    }

    function showEmptyState(message = 'No songs are available right now. Generate one to get started!') {
      const list = document.getElementById('songList');
      if (!list) return;
      list.innerHTML = `<li class="empty-state">${message}</li>`;
    }

    function formatDate(date) {
      if (!(date instanceof Date) || Number.isNaN(date.getTime())) {
        return '';
      }
      return date.toLocaleDateString(undefined, {
        weekday: 'short',
        month: 'short',
        day: 'numeric',
      });
    }

    function formatTime(date) {
      if (!(date instanceof Date) || Number.isNaN(date.getTime())) {
        return '';
      }
      return date.toLocaleTimeString(undefined, {
        hour: 'numeric',
        minute: '2-digit',
      });
    }

    function formatDateTime(date) {
      const datePart = formatDate(date);
      const timePart = formatTime(date);
      if (datePart && timePart) return `${datePart} â€¢ ${timePart}`;
      return datePart || timePart || 'Generated';
    }

    function renderSongList(songs) {
      songsCache = songs;
      const list = document.getElementById('songList');
      const template = document.getElementById('songItemTemplate');

      if (!songs.length) {
        showEmptyState('No Suno songs have been generated yet. Be the first to spin one!');
        return;
      }

      list.innerHTML = '';

      songs.forEach((song) => {
        const clone = template.content.cloneNode(true);
        const button = clone.querySelector('button');
        const title = clone.querySelector('.song-title');
        const meta = clone.querySelector('.song-meta');

        title.textContent = song.title;
        const metaPieces = [];
        if (song.artist) metaPieces.push(song.artist);
        metaPieces.push(formatDateTime(song.createdAt));
        meta.textContent = metaPieces.filter(Boolean).join(' â€¢ ');

        button.dataset.id = song.id || '';
        button.classList.toggle('active', Boolean(song.id && song.id === currentSongId));
        button.addEventListener('click', () => {
          setCurrentSong(song);
        });

        list.appendChild(clone);
      });
    }

    function setCurrentSong(song) {
      if (!song) {
        resetNowPlaying();
        return;
      }

      currentSongId = song.id || null;

      const title = document.getElementById('songTitle');
      const meta = document.getElementById('songMeta');
      const description = document.getElementById('songDescription');
      const audio = document.getElementById('audioPlayer');
      const source = document.getElementById('audioSource');
      const tag = document.getElementById('songTag');

      title.textContent = song.title || 'Daily Spin (Suno)';
      const metaPieces = [];
      metaPieces.push(song.artist || 'Suno AI');
      const formatted = formatDateTime(song.createdAt);
      if (formatted) metaPieces.push(formatted);
      meta.textContent = metaPieces.join(' â€” ');

      description.textContent = song.lyrics || 'Your Suno track is ready. Enjoy!';
      source.src = song.audioUrl || '';
      audio.load();
      if (song.audioUrl) {
        audio.play().catch(() => {});
      }

      const isNewest = songsCache.length > 0 && songsCache[0]?.id === song.id;
      if (isNewest) {
        tag.textContent = 'Now Playing';
        tag.style.background = 'rgba(245, 158, 11, 0.18)';
        tag.style.color = 'var(--accent)';
      } else {
        tag.textContent = 'From the Archives';
        tag.style.background = 'rgba(148, 163, 184, 0.2)';
        tag.style.color = 'var(--text)';
      }

      document.querySelectorAll('.song-list button').forEach((button) => {
        button.classList.toggle('active', button.dataset.id === (song.id || ''));
      });
    }

    async function subscribeToSongs() {
      if (!db) return;

      if (unsubscribeSongs) {
        unsubscribeSongs();
      }

      const songsRef = collection(db, 'spins');
      const songsQuery = query(songsRef, orderBy('createdAt', 'desc'), limit(50));

      unsubscribeSongs = onSnapshot(
        songsQuery,
        (snapshot) => {
          const songs = snapshot.docs
            .map((doc) => {
              const data = doc.data();
              const createdAt =
                (data.createdAt && typeof data.createdAt.toDate === 'function'
                  ? data.createdAt.toDate()
                  : data.generatedAtIso
                  ? new Date(data.generatedAtIso)
                  : null);

              return {
                id: doc.id,
                title: data.title || 'Daily Spin (Suno)',
                artist: data.artist || 'Suno AI',
                lyrics: data.lyrics || '',
                audioUrl: data.audioUrl || data.streamUrl || '',
                createdAt,
              };
            })
            .filter((song) => Boolean(song.audioUrl));

          if (!songs.length) {
            currentSongId = null;
            songsCache = [];
            showEmptyState('No Suno songs have been generated yet. Be the first to spin one!');
            resetNowPlaying();
            return;
          }

          renderSongList(songs);

          const selected = currentSongId
            ? songs.find((entry) => entry.id === currentSongId)
            : null;

          if (selected) {
            setCurrentSong(selected);
          } else {
            setCurrentSong(songs[0]);
          }
        },
        (error) => {
          console.error('Failed to load songs from Firebase:', error);
          showEmptyState('Unable to load recent spins right now.');
        },
      );
    }

    async function loadSongs() {
      try {
        await initFirebase();
        subscribeToSongs();
      } catch (error) {
        console.error('Unable to initialise Firebase:', error);
        showEmptyState('We had trouble loading the recent spins. Please try again soon.');
      }
    }

    function populateFromSuno(clip) {
      const audio = document.getElementById('audioPlayer');
      const source = document.getElementById('audioSource');
      const title = document.getElementById('songTitle');
      const meta = document.getElementById('songMeta');
      const desc = document.getElementById('songDescription');
      const tag = document.getElementById('songTag');

      const createdAt = clip.created_at ? new Date(clip.created_at) : new Date();

      title.textContent = clip.title || 'Daily Spin (Suno)';
      meta.textContent = `Suno AI â€” ${formatDateTime(createdAt)}`;
      desc.textContent = clip.lyrics || 'Your Suno track is ready. Enjoy!';
      source.src = clip.audio_url || '';
      audio.load();
      if (clip.audio_url) {
        audio.play().catch(() => {});
      }

      tag.textContent = 'Now Playing';
      tag.style.background = 'rgba(245, 158, 11, 0.18)';
      tag.style.color = 'var(--accent)';

      currentSongId = null;
    }

    async function pollForAudioIds({ taskIds = [], clipIds = [] }, { timeoutMs = 180000, intervalMs = 5000 } = {}) {
      const start = Date.now();
      while (Date.now() - start < timeoutMs) {
        const params = clipIds.length
          ? `clip_ids=${encodeURIComponent(clipIds.join(','))}`
          : `task_ids=${encodeURIComponent(taskIds.join(','))}`;

        try {

          const r = await fetch(`/api/song-status?${params}`);
          if (!r.ok) {
            await new Promise(res => setTimeout(res, intervalMs));
            continue;
          }

          const { data = [] } = await r.json();
          const ready = data.find((d) => d && d.audio_url);
          if (ready) return ready;

          
        } catch (e) {
          await new Promise((res) => setTimeout(res, intervalMs));
          continue;
        }
      }
      throw new Error('Timed out waiting for Suno audio.');
    }

    async function saveGeneratedSong(clip, prompt) {
      await initFirebase();
      if (!db) throw new Error('Firebase is not available.');

      if (!clip || !clip.audio_url) {
        throw new Error('Suno did not return an audio URL to save.');
      }

      const songsRef = collection(db, 'spins');
      const nowIso = new Date().toISOString();

      await addDoc(songsRef, {
        title: clip.title || 'Daily Spin (Suno)',
        artist: clip.artist || 'Suno AI',
        lyrics: (clip.lyrics || '').trim(),
        audioUrl: clip.audio_url,
        prompt: prompt || '',
        createdAt: serverTimestamp(),
        generatedAtIso: nowIso,
      });
    }

    async function generateSongFromNews() {
      const button = document.getElementById('generateSongButton');
      const status = document.getElementById('generateSongStatus');
      if (!button || !status) return;

      button.disabled = true;
      status.textContent = 'Crafting a Suno prompt from today\'s headlines...';

      try {
        const response = await fetch('/api/generate-song', { method: 'POST' });

        if (response.status !== 202) {
          const e = await response.json().catch(() => ({}));
          throw new Error(e.error || 'Failed to create Suno task');
        }

        const body = await response.json();
        const taskIds = body.task_ids || [];
        const clipIds = body.clip_ids || [];

        if (!taskIds.length && !clipIds.length) {
          console.warn('Create response body:', body); // leaves a breadcrumb
          throw new Error('Suno did not return any task or clip IDs');
        }

        // status.textContent = 'Song requested. Waiting for Suno to renderâ€¦';
        status.textContent = 'Song requested. Fetching audioâ€¦';

        const clip = await pollForAudioIds({ taskIds, clipIds }, { timeoutMs: 180000, intervalMs: 15000 });
        populateFromSuno(clip);

        let saved = false;
        try {
          await saveGeneratedSong(clip, body.prompt);
          saved = true;
        } catch (persistError) {
          console.error('Failed to save song to Firebase:', persistError);
        }

        status.textContent = saved
          ? 'Your Suno song is ready and saved to Recent Spins.'
          : 'Your Suno song is ready, but it could not be saved to Recent Spins.';
      } catch (error) {
        console.error('Failed to generate Suno song:', error);
        status.textContent = error.message || 'Something went wrong while generating the song.';
      } finally {
        button.disabled = false;
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      loadSongs();
      const button = document.getElementById('generateSongButton');
      if (button) {
        button.addEventListener('click', generateSongFromNews);
      }
    });
  </script>
</body>
</html>
