<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Daily Spin</title>
  <style>
    :root {
      color-scheme: light dark;
      --bg: #0d1117;
      --surface: #161b22;
      --surface-alt: #1f2933;
      --accent: #f59e0b;
      --text: #f8fafc;
      --muted: #94a3b8;
      font-family: "Inter", "Segoe UI", Roboto, system-ui, -apple-system, sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      background: radial-gradient(circle at top left, rgba(245, 158, 11, 0.08), transparent 45%),
        var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
      padding: 2rem;
    }

    .app-shell {
      display: grid;
      grid-template-columns: minmax(240px, 280px) minmax(320px, 640px);
      gap: 2rem;
      width: min(1080px, 100%);
      background: rgba(15, 23, 42, 0.7);
      backdrop-filter: blur(24px);
      border-radius: 28px;
      padding: 2rem;
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.4);
    }

    @media (max-width: 860px) {
      body {
        padding: 1rem;
      }

      .app-shell {
        grid-template-columns: 1fr;
        padding: 1.5rem;
      }
    }

    h1, h2, h3, p {
      margin: 0;
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }

    .sidebar-section {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      max-height: 50vh;
    }

    .sidebar-section header {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .sidebar-section header h2 {
      font-size: 1.25rem;
      font-weight: 600;
      letter-spacing: 0.01em;
    }

    .sidebar-section header p {
      font-size: 0.9rem;
      color: var(--muted);
    }

    .headline-list,
    .song-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      list-style: none;
      padding: 0;
      margin: 0;
      overflow-y: auto;
    }

    .headline-list {
      max-height: 52vh;
    }

    .song-list {
      max-height: 44vh;
    }

    .headline-list button,
    .song-list button {
      width: 100%;
      background: transparent;
      border: 1px solid rgba(148, 163, 184, 0.2);
      color: inherit;
      padding: 0.9rem 1rem;
      border-radius: 14px;
      text-align: left;
      cursor: pointer;
      transition: transform 0.15s ease, border-color 0.2s ease, background 0.2s ease;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .headline-list button:hover,
    .song-list button:hover {
      transform: translateY(-2px);
      border-color: rgba(245, 158, 11, 0.5);
      background: rgba(15, 23, 42, 0.55);
    }

    .headline-list button.active,
    .song-list button.active {
      border-color: var(--accent);
      background: rgba(245, 158, 11, 0.12);
    }

    .song-title {
      font-weight: 600;
      font-size: 1rem;
    }

    .song-meta {
      font-size: 0.85rem;
      color: var(--muted);
      display: flex;
      gap: 0.5rem;
      align-items: baseline;
    }

    .player-panel {
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.92), rgba(17, 24, 39, 0.85));
      border-radius: 24px;
      padding: 2rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
      justify-content: space-between;
      box-shadow: inset 0 1px 0 rgba(148, 163, 184, 0.07);
    }

    .player-header {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
    }

    .player-header h1 {
      font-size: clamp(2rem, 4vw, 2.8rem);
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    .player-header p {
      color: var(--muted);
      font-size: 1rem;
      line-height: 1.6;
    }

    .player-header .tag {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.35rem 0.85rem;
      background: rgba(245, 158, 11, 0.18);
      color: var(--accent);
      border-radius: 999px;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 600;
    }

    audio {
      width: 100%;
      border-radius: 12px;
      height: 54px;
      background: rgba(15, 23, 42, 0.6);
    }

    .lyrics {
      font-size: 0.95rem;
      line-height: 1.7;
      color: rgba(226, 232, 240, 0.9);
      white-space: pre-wrap;
      max-height: 200px;
      overflow-y: auto;
      padding-right: 0.75rem;
    }

    .empty-state {
      color: var(--muted);
      text-align: center;
      padding: 2rem;
    }

    .generate-song {
      margin-top: auto;
      padding-top: 1.25rem;
      border-top: 1px solid rgba(148, 163, 184, 0.15);
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .generate-song-status {
      font-size: 0.9rem;
      color: var(--muted);
      min-height: 1.4em;
    }

    .generate-song button {
      align-self: flex-start;
      background: var(--accent);
      color: #0b0f16;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 999px;
      font-weight: 600;
      letter-spacing: 0.02em;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.2s ease;
    }

    .generate-song button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 10px 30px rgba(245, 158, 11, 0.35);
    }

    .generate-song button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      box-shadow: none;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <aside class="sidebar">
      <section class="sidebar-section">
        <header>
          <h2>Top Headlines</h2>
          <p>Select a headline to read the story and optionally spin a new track.</p>
        </header>
        <ul class="headline-list" id="headlineList"></ul>
      </section>

      <section class="sidebar-section">
        <header>
          <h2>Recent Spins</h2>
          <p>The latest Suno creations saved from Daily Spin.</p>
        </header>
        <ul class="song-list" id="songList"></ul>
      </section>
    </aside>

    <main class="player-panel">
      <div class="player-header">
        <span class="tag" id="songTag">Top Stories</span>
        <h1 id="songTitle">Choose a headline</h1>
        <p id="songMeta">Select a headline from the list to load the article.</p>
      </div>

      <audio id="audioPlayer" controls preload="none">
        <source id="audioSource" src="" type="audio/mpeg" />
        Your browser does not support the audio element.
      </audio>

      <section class="lyrics" id="songDescription">
        Article summaries will appear here after you pick a headline.
      </section>

      <section class="generate-song">
        <button type="button" id="generateSongButton" disabled>Generate Song</button>
        <p class="generate-song-status" id="generateSongStatus" aria-live="polite"></p>
      </section>
    </main>
  </div>

  <template id="headlineItemTemplate">
    <li>
      <button type="button" data-role="headline-item">
        <span class="song-title"></span>
        <span class="song-meta"></span>
      </button>
    </li>
  </template>

  <template id="songItemTemplate">
    <li>
      <button type="button" data-role="song-item">
        <span class="song-title"></span>
        <span class="song-meta"></span>
      </button>
    </li>
  </template>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import {
      getFirestore,
      collection,
      query,
      orderBy,
      limit,
      onSnapshot,
      addDoc,
      serverTimestamp,
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    let db = null;
    let songsCache = [];
    let currentSongId = null;
    let unsubscribeSongs = null;
    let firebaseInitPromise = null;
    let headlinesCache = [];
    let currentHeadlineKey = null;
    let selectedStory = null;
    let latestArticleContent = '';
    let isGenerating = false;
    let latestSummary = '';
    let generateSongButton = null;

    async function initFirebase() {
      if (firebaseInitPromise) return firebaseInitPromise;

      firebaseInitPromise = (async () => {
        const response = await fetch('/api/firebase-config');
        if (!response.ok) {
          throw new Error('Unable to load Firebase configuration.');
        }

        const config = await response.json();
        const app = initializeApp(config);
        db = getFirestore(app);
        return db;
      })();

      return firebaseInitPromise;
    }

    function updateGenerateButton({ disabled, text } = {}) {
      if (!generateSongButton) return;
      if (typeof disabled === 'boolean') {
        generateSongButton.disabled = disabled;
      }
      if (typeof text === 'string') {
        generateSongButton.textContent = text;
      }
    }

    function resetNowPlaying() {
      const title = document.getElementById('songTitle');
      const meta = document.getElementById('songMeta');
      const description = document.getElementById('songDescription');
      const audio = document.getElementById('audioPlayer');
      const source = document.getElementById('audioSource');
      const tag = document.getElementById('songTag');

      title.textContent = 'Choose a headline';
      meta.textContent = 'Select a news headline to read the story and optionally spin a Suno track.';
      description.textContent = 'Article summaries will appear here after you pick a headline.';
      source.src = '';
      audio.load();
      tag.textContent = 'Top Stories';
      tag.style.background = 'rgba(96, 165, 250, 0.18)';
      tag.style.color = '#60a5fa';

      selectedStory = null;
      latestArticleContent = '';
      latestSummary = '';
      updateGenerateButton({ disabled: true, text: 'Generate Song' });
    }

    function showListEmptyState(listId, message) {
      const list = document.getElementById(listId);
      if (!list) return;
      list.innerHTML = `<li class="empty-state">${message}</li>`;
    }

    function updateStatus(message) {
      const status = document.getElementById('generateSongStatus');
      if (!status) return;
      status.textContent = message || '';
    }

    function renderHeadlineList(stories) {
      headlinesCache = stories;
      const list = document.getElementById('headlineList');
      const template = document.getElementById('headlineItemTemplate');
      if (!list || !template) return;

      if (!stories.length) {
        showListEmptyState('headlineList', 'No fresh headlines were found. Try again later.');
        return;
      }

      list.innerHTML = '';

      stories.forEach((story) => {
        const clone = template.content.cloneNode(true);
        const button = clone.querySelector('button');
        const title = clone.querySelector('.song-title');
        const meta = clone.querySelector('.song-meta');

        const key = story.link || `${story.source || 'source'}:${story.headline}`;
        const preview = (story.summary || '').trim();
        const truncatedPreview = preview.length > 140 ? `${preview.slice(0, 140).trimEnd()}…` : preview;

        title.textContent = story.headline || 'Untitled story';
        meta.textContent = [story.source, truncatedPreview].filter(Boolean).join(' • ');

        button.dataset.id = key;
        button.classList.toggle('active', key === currentHeadlineKey);
        button.addEventListener('click', () => {
          handleHeadlineSelection({ ...story, key });
        });

        list.appendChild(clone);
      });
    }

    function handleHeadlineSelection(story) {
      if (!story || !story.key) {
        updateStatus('This headline is missing critical information.');
        return;
      }

      if (isGenerating && story.key !== currentHeadlineKey) {
        updateStatus('Please wait until the current track finishes generating.');
        return;
      }

      currentHeadlineKey = story.key;
      selectedStory = story;
      latestArticleContent = '';
      latestSummary = '';
      renderHeadlineList(headlinesCache);

      const title = document.getElementById('songTitle');
      const meta = document.getElementById('songMeta');
      const description = document.getElementById('songDescription');
      const tag = document.getElementById('songTag');

      if (title) title.textContent = story.headline || 'Selected headline';
      if (meta) meta.textContent = story.source || 'Breaking news';
      if (description)
        description.textContent = story.summary || 'Fetching the full article…';
      if (tag) {
        tag.textContent = 'Article';
        tag.style.background = 'rgba(245, 158, 11, 0.18)';
        tag.style.color = 'var(--accent)';
      }

      updateGenerateButton({ disabled: true, text: 'Loading Article…' });
      updateStatus('Fetching the full article…');
      fetchAndDisplayArticle(story);
    }

    async function fetchAndDisplayArticle(story) {
      if (!story?.link) {
        updateStatus('The selected headline does not have a readable article link.');
        updateGenerateButton({ disabled: true, text: 'Generate Song' });
        return;
      }

      try {
        const response = await fetch('/api/article-content', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url: story.link }),
        });

        const body = await response.json().catch(() => ({}));

        if (!response.ok) {
          const message = body?.error || 'Unable to load the full article right now.';
          throw new Error(message);
        }

        const article = (body.content || '').trim();
        latestArticleContent = article;

        if (!selectedStory || selectedStory.key !== story.key) {
          return;
        }

        const description = document.getElementById('songDescription');
        if (description) {
          const summary = (story.summary || '').trim();
          const combined = summary && article ? `${summary}\n\n${article}` : summary || article;
          description.textContent = combined || 'The article is available, but it is empty.';
        }

        const tag = document.getElementById('songTag');
        if (tag) {
          tag.textContent = 'Article Ready';
          tag.style.background = 'rgba(52, 211, 153, 0.2)';
          tag.style.color = '#34d399';
        }

        updateStatus('Article loaded. Ready to generate a Suno song.');
        updateGenerateButton({ disabled: false, text: 'Generate Song' });
      } catch (error) {
        console.error('Failed to load full article:', error);
        if (!selectedStory || selectedStory.key !== story.key) {
          return;
        }
        const description = document.getElementById('songDescription');
        if (description) {
          description.textContent =
            story.summary || 'Unable to load the full article. You can still try generating a song.';
        }

        updateStatus(error.message || 'Unable to load the full article.');
        updateGenerateButton({ disabled: false, text: 'Generate Song' });
      }
    }

    async function generateSongForHeadline(story) {
      if (!story?.link) {
        updateStatus('The selected headline does not have a readable article link.');
        return;
      }

      if (isGenerating) {
        return;
      }

      isGenerating = true;
      latestSummary = '';
      updateGenerateButton({ disabled: true, text: 'Generating…' });

      const audio = document.getElementById('audioPlayer');
      const source = document.getElementById('audioSource');
      if (audio && source) {
        source.src = '';
        audio.load();
      }

      try {
        const response = await fetch('/api/generate-song', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            url: story.link,
            headline: story.headline,
            source: story.source,
          }),
        });

        const body = await response.json().catch(() => ({}));

        if (response.status !== 202) {
          const message = body?.error || 'Failed to create a Suno generation task.';
          throw new Error(message);
        }

        const summary = body.summary || body.prompt || story.summary || '';
        latestSummary = summary;

        const description = document.getElementById('songDescription');
        if (description) {
          description.textContent = summary || 'Waiting for OpenRouter to provide a summary…';
        }

        const taskIds = Array.isArray(body.task_ids) ? body.task_ids : [];
        const clipIds = Array.isArray(body.clip_ids) ? body.clip_ids : [];

        if (!taskIds.length && !clipIds.length) {
          throw new Error('Suno did not return any task or clip identifiers.');
        }

        updateStatus('Song requested. Waiting for Suno to render…');

        const clip = await pollForAudioIds({ taskIds, clipIds }, { timeoutMs: 180000, intervalMs: 15000 });

        const createdAt = clip.created_at ? new Date(clip.created_at) : new Date();
        const summaryText = (latestSummary || body.prompt || '').trim();
        const songRecord = {
          id: clip.id || null,
          audioUrl: clip.audio_url || '',
          title: clip.title || 'Daily Spin (Suno)',
          artist: clip.artist || 'Suno AI',
          sunoTitle: clip.title || 'Daily Spin (Suno)',
          sunoArtist: clip.artist || 'Suno AI',
          lyrics: (summaryText || clip.lyrics || '').trim(),
          prompt: summaryText,
          createdAt,
          generatedAtIso: createdAt.toISOString(),
          articleHeadline: story.headline || '',
          articleSummary: story.summary || '',
          articleSource: story.source || '',
          articleUrl: story.link || '',
          articleContent: latestArticleContent || '',
        };

        populateFromSuno(songRecord);

        let saved = false;
        try {
          await saveGeneratedSong(songRecord);
          saved = true;
        } catch (persistError) {
          console.error('Failed to save song to Firebase:', persistError);
        }

        updateStatus(
          saved
            ? 'Your Suno song is ready and saved to Recent Spins.'
            : 'Your Suno song is ready, but it could not be saved to Recent Spins.',
        );
        updateGenerateButton({ disabled: false, text: 'Generate Another Song' });
      } catch (error) {
        console.error('Failed to generate song from headline:', error);
        updateStatus(error.message || 'Something went wrong while generating the song.');
        latestSummary = '';
        if (selectedStory && selectedStory.key === story.key) {
          updateGenerateButton({ disabled: false, text: 'Try Again' });
        } else {
          updateGenerateButton({ disabled: false, text: 'Generate Song' });
        }
      } finally {
        isGenerating = false;
        renderHeadlineList(headlinesCache);
        if (
          selectedStory &&
          selectedStory.key === story.key &&
          generateSongButton &&
          generateSongButton.disabled
        ) {
          updateGenerateButton({ disabled: false, text: 'Generate Song' });
        }
      }
    }

    function formatDate(date) {
      if (!(date instanceof Date) || Number.isNaN(date.getTime())) {
        return '';
      }
      return date.toLocaleDateString(undefined, {
        weekday: 'short',
        month: 'short',
        day: 'numeric',
      });
    }

    function formatTime(date) {
      if (!(date instanceof Date) || Number.isNaN(date.getTime())) {
        return '';
      }
      return date.toLocaleTimeString(undefined, {
        hour: 'numeric',
        minute: '2-digit',
      });
    }

    function formatDateTime(date) {
      const datePart = formatDate(date);
      const timePart = formatTime(date);
      if (datePart && timePart) return `${datePart} • ${timePart}`;
      return datePart || timePart || 'Generated';
    }

    function renderSongList(songs) {
      songsCache = songs;
      const list = document.getElementById('songList');
      const template = document.getElementById('songItemTemplate');

      if (!songs.length) {
        showListEmptyState('songList', 'No Suno songs have been generated yet. Be the first to spin one!');
        return;
      }

      list.innerHTML = '';

      songs.forEach((song) => {
        const clone = template.content.cloneNode(true);
        const button = clone.querySelector('button');
        const title = clone.querySelector('.song-title');
        const meta = clone.querySelector('.song-meta');

        const displayTitle = song.articleHeadline || song.sunoTitle || song.title || 'Daily Spin (Suno)';
        title.textContent = displayTitle;
        const metaPieces = [];
        if (song.sunoTitle || song.title) metaPieces.push(`Suno: ${song.sunoTitle || song.title}`);
        if (song.articleSource) metaPieces.push(song.articleSource);
        const createdAt = formatDateTime(song.createdAt);
        if (createdAt) metaPieces.push(createdAt);
        meta.textContent = metaPieces.filter(Boolean).join(' • ');

        button.dataset.id = song.id || '';
        button.classList.toggle('active', Boolean(song.id && song.id === currentSongId));
        button.addEventListener('click', () => {
          setCurrentSong(song);
        });

        list.appendChild(clone);
      });
    }

    function setCurrentSong(song) {
      if (!song) {
        resetNowPlaying();
        return;
      }

      currentSongId = song.id || null;

      const title = document.getElementById('songTitle');
      const meta = document.getElementById('songMeta');
      const description = document.getElementById('songDescription');
      const audio = document.getElementById('audioPlayer');
      const source = document.getElementById('audioSource');
      const tag = document.getElementById('songTag');

      const displayTitle = song.articleHeadline || song.sunoTitle || song.title || 'Daily Spin (Suno)';
      title.textContent = displayTitle;
      const metaPieces = [];
      if (song.sunoTitle || song.title) metaPieces.push(`Suno: ${song.sunoTitle || song.title}`);
      if (song.articleSource) metaPieces.push(song.articleSource);
      const formatted = formatDateTime(song.createdAt);
      if (formatted) metaPieces.push(formatted);
      meta.textContent = metaPieces.join(' — ') || 'Generated';

      const detailSections = [];
      if (song.articleHeadline) {
        detailSections.push(`Headline: ${song.articleHeadline}`);
      }
      if (song.articleContent) {
        detailSections.push(`Article:\n${song.articleContent}`);
      } else if (song.articleSummary) {
        detailSections.push(`Summary:\n${song.articleSummary}`);
      }
      if (song.lyrics) {
        detailSections.push(`Lyrics:\n${song.lyrics}`);
      }
      description.textContent = detailSections.join('\n\n') || 'Details are unavailable for this spin.';
      source.src = song.audioUrl || song.streamUrl || '';
      audio.load();
      if (source.src) {
        audio.play().catch(() => {});
      }

      const isNewest = songsCache.length > 0 && songsCache[0]?.id === song.id;
      if (isNewest) {
        tag.textContent = 'Now Playing';
        tag.style.background = 'rgba(245, 158, 11, 0.18)';
        tag.style.color = 'var(--accent)';
      } else {
        tag.textContent = 'From the Archives';
        tag.style.background = 'rgba(148, 163, 184, 0.2)';
        tag.style.color = 'var(--text)';
      }

      document.querySelectorAll('[data-role="song-item"]').forEach((button) => {
        button.classList.toggle('active', button.dataset.id === (song.id || ''));
      });
    }

    async function subscribeToSongs() {
      if (!db) return;

      if (unsubscribeSongs) {
        unsubscribeSongs();
      }

      const songsRef = collection(db, 'spins');
      const songsQuery = query(songsRef, orderBy('createdAt', 'desc'), limit(50));

      unsubscribeSongs = onSnapshot(
        songsQuery,
        (snapshot) => {
          const songs = snapshot.docs
            .map((doc) => {
              const data = doc.data();
              const createdAt =
                (data.createdAt && typeof data.createdAt.toDate === 'function'
                  ? data.createdAt.toDate()
                  : data.generatedAtIso
                  ? new Date(data.generatedAtIso)
                  : null);

              return {
                id: doc.id,
                title: data.title || data.sunoTitle || 'Daily Spin (Suno)',
                sunoTitle: data.sunoTitle || data.title || 'Daily Spin (Suno)',
                artist: data.artist || data.sunoArtist || 'Suno AI',
                sunoArtist: data.sunoArtist || data.artist || 'Suno AI',
                lyrics: data.lyrics || data.prompt || '',
                audioUrl: data.audioUrl || data.streamUrl || '',
                createdAt,
                prompt: data.prompt || '',
                articleHeadline: data.articleHeadline || '',
                articleSummary: data.articleSummary || data.prompt || '',
                articleSource: data.articleSource || '',
                articleUrl: data.articleUrl || '',
                articleContent: data.articleContent || '',
              };
            })
            .filter((song) => Boolean(song.audioUrl));

          if (!songs.length) {
            currentSongId = null;
            songsCache = [];
            showListEmptyState('songList', 'No Suno songs have been generated yet. Be the first to spin one!');
            resetNowPlaying();
            return;
          }

          renderSongList(songs);

          const selected = currentSongId
            ? songs.find((entry) => entry.id === currentSongId)
            : null;

          if (selected) {
            setCurrentSong(selected);
          } else {
            setCurrentSong(songs[0]);
          }
        },
        (error) => {
          console.error('Failed to load songs from Firebase:', error);
          showListEmptyState('songList', 'Unable to load recent spins right now.');
        },
      );
    }

    async function loadHeadlines() {
      const headlineList = document.getElementById('headlineList');
      if (headlineList) {
        headlineList.innerHTML = '<li class="empty-state">Loading headlines…</li>';
      }

      try {
        const response = await fetch('/api/news-headlines');
        const payload = await response.json().catch(() => ({}));

        if (!response.ok) {
          const message = payload?.error || 'Unable to fetch the latest headlines.';
          throw new Error(message);
        }

        const stories = Array.isArray(payload?.stories) ? payload.stories : [];

        if (!stories.length) {
          showListEmptyState('headlineList', 'No headlines are available right now. Please check back soon.');
          updateStatus('Headlines are unavailable right now.');
          return;
        }

        renderHeadlineList(stories);
        updateStatus('Select a headline to read the article and optionally generate a Suno track.');
      } catch (error) {
        console.error('Unable to load headlines:', error);
        showListEmptyState('headlineList', 'We could not load the latest headlines. Please try again later.');
        updateStatus(error.message || 'Unable to load headlines right now.');
        resetNowPlaying();
      }
    }

    function populateFromSuno(song) {
      const audio = document.getElementById('audioPlayer');
      const source = document.getElementById('audioSource');
      const title = document.getElementById('songTitle');
      const meta = document.getElementById('songMeta');
      const desc = document.getElementById('songDescription');
      const tag = document.getElementById('songTag');

      const createdAt = song.createdAt instanceof Date ? song.createdAt : new Date();
      const metaPieces = [];
      if (song.sunoTitle) metaPieces.push(`Suno: ${song.sunoTitle}`);
      if (song.articleSource) metaPieces.push(song.articleSource);
      const formatted = formatDateTime(createdAt);
      if (formatted) metaPieces.push(formatted);

      title.textContent = song.articleHeadline || song.sunoTitle || 'Daily Spin (Suno)';
      meta.textContent = metaPieces.join(' — ') || 'Generated';

      const detailSections = [];
      if (song.articleHeadline) {
        detailSections.push(`Headline: ${song.articleHeadline}`);
      }
      if (song.articleContent) {
        detailSections.push(`Article:\n${song.articleContent}`);
      } else if (song.articleSummary) {
        detailSections.push(`Summary:\n${song.articleSummary}`);
      }
      if (song.lyrics) {
        detailSections.push(`Lyrics:\n${song.lyrics}`);
      }
      desc.textContent = detailSections.join('\n\n') || 'Your Suno track is ready. Enjoy!';
      source.src = song.audioUrl || song.streamUrl || '';
      audio.load();
      if (source.src) {
        audio.play().catch(() => {});
      }

      tag.textContent = 'Now Playing';
      tag.style.background = 'rgba(245, 158, 11, 0.18)';
      tag.style.color = 'var(--accent)';

      currentSongId = null;
    }

    async function pollForAudioIds({ taskIds = [], clipIds = [] }, { timeoutMs = 180000, intervalMs = 5000 } = {}) {
      const start = Date.now();
      while (Date.now() - start < timeoutMs) {
        const params = clipIds.length
          ? `clip_ids=${encodeURIComponent(clipIds.join(','))}`
          : `task_ids=${encodeURIComponent(taskIds.join(','))}`;

        try {

          const r = await fetch(`/api/song-status?${params}`);
          if (!r.ok) {
            await new Promise(res => setTimeout(res, intervalMs));
            continue;
          }

          const { data = [] } = await r.json();
          const ready = data.find((d) => d && d.audio_url);
          if (ready) return ready;

          
        } catch (e) {
          await new Promise((res) => setTimeout(res, intervalMs));
          continue;
        }
      }
      throw new Error('Timed out waiting for Suno audio.');
    }

    async function saveGeneratedSong(song) {
      await initFirebase();
      if (!db) throw new Error('Firebase is not available.');

      if (!song || !song.audioUrl) {
        throw new Error('Suno did not return an audio URL to save.');
      }

      const songsRef = collection(db, 'spins');
      const generatedIso = song.generatedAtIso || (song.createdAt instanceof Date
        ? song.createdAt.toISOString()
        : new Date().toISOString());

      await addDoc(songsRef, {
        sunoTitle: song.sunoTitle || song.title || 'Daily Spin (Suno)',
        sunoArtist: song.sunoArtist || song.artist || 'Suno AI',
        lyrics: (song.lyrics || '').trim(),
        audioUrl: song.audioUrl,
        prompt: song.prompt || '',
        articleHeadline: song.articleHeadline || '',
        articleSummary: song.articleSummary || '',
        articleSource: song.articleSource || '',
        articleUrl: song.articleUrl || '',
        articleContent: song.articleContent || '',
        createdAt: serverTimestamp(),
        generatedAtIso: generatedIso,
      });
    }

    document.addEventListener('DOMContentLoaded', async () => {
      generateSongButton = document.getElementById('generateSongButton');
      if (generateSongButton) {
        generateSongButton.addEventListener('click', () => {
          if (!selectedStory) {
            updateStatus('Select a headline to read the story before generating a song.');
            return;
          }
          generateSongForHeadline(selectedStory);
        });
      }

      showListEmptyState('songList', 'Loading recent spins…');
      resetNowPlaying();
      loadHeadlines();

      try {
        await initFirebase();
        await subscribeToSongs();
      } catch (error) {
        console.error('Failed to initialise Firebase:', error);
        showListEmptyState('songList', 'Unable to load recent spins right now.');
      }
    });
  </script>
</body>
</html>
